<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>BedrockLab | Display Entity Creator</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap');

        body {
            font-family: 'Inter', sans-serif;
            background-color: #0f172a;
            color: #f1f5f9;
            overflow: hidden;
            /* Prevent body scroll */
        }

        .panel-bg {
            background-color: #1a2333;
        }

        .input-box {
            background-color: #0f172a;
            border: 1px solid #334155;
            color: #fff;
        }

        input[type=range] {
            height: 4px;
            -webkit-appearance: none;
            background: #334155;
            border-radius: 2px;
        }

        input[type=range]::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 16px;
            height: 16px;
            background: #38bdf8;
            border-radius: 50%;
            cursor: pointer;
            border: 2px solid #0f172a;
        }

        .custom-scrollbar::-webkit-scrollbar {
            width: 4px;
            height: 4px;
        }

        .custom-scrollbar::-webkit-scrollbar-thumb {
            background: #475569;
            border-radius: 10px;
        }

        .custom-scrollbar::-webkit-scrollbar-track {
            background: #0f172a;
        }

        /* Layout Logic:
           - Mobile: Flex-col (Viewport Top, Controls Bottom)
           - Desktop: Flex-row (Sidebar Left, Viewport Right)
        */

        #sidebar-container {
            display: flex;
            flex-direction: column;
        }

        select option {
            background-color: #1a2333;
            color: #f1f5f9;
        }

        @media (max-width: 640px) {
            #output-actions {
                flex-direction: column;
                gap: 0.5rem;
            }

            #output-actions button {
                width: 100%;
            }
        }
    </style>
</head>

<body class="h-screen flex flex-col w-full">

    <!-- Header -->
    <header
        class="h-12 lg:h-14 flex-none flex items-center justify-between px-4 lg:px-6 border-b border-white/5 panel-bg z-50">
        <div class="flex items-center gap-3">
            <div
                class="w-7 h-7 bg-sky-500 rounded flex items-center justify-center font-black text-white shadow-lg shadow-sky-500/20 text-sm">
                B</div>
            <h1 class="text-sm lg:text-lg font-extrabold tracking-tight">BedrockLab</h1>
        </div>
        <div class="flex items-center gap-3">
            <button onclick="resetAll()"
                class="text-[10px] font-bold uppercase tracking-widest text-slate-400 hover:text-red-400 transition-colors bg-white/5 px-3 py-1.5 rounded">
                Reset
            </button>
        </div>
    </header>

    <!-- Main Content Wrapper -->
    <div class="flex-1 flex flex-col lg:flex-row overflow-hidden relative w-full">

        <!-- 3D Viewport (Top on Mobile, Right on Desktop) -->
        <!-- Order-1 on mobile ensures it's at the top. Order-2 on desktop puts it to the right. -->
        <main
            class="relative order-1 lg:order-2 w-full lg:flex-1 h-[45vh] lg:h-full bg-[#0b111d] flex flex-col border-b border-white/10 lg:border-b-0">
            <div id="viewport-container" class="w-full h-full relative z-0"></div>

            <!-- Output Panel Overlay -->
            <div id="outputPanel"
                class="absolute bottom-4 left-4 right-4 panel-bg border border-white/10 rounded-xl p-4 shadow-2xl transform translate-y-[120%] opacity-0 pointer-events-none transition-all duration-300 z-40 max-h-[80%] flex flex-col">
                <div
                    class="flex flex-col sm:flex-row sm:items-center justify-between mb-3 border-b border-white/5 pb-2 gap-2 flex-none">
                    <span class="text-[10px] font-black uppercase tracking-[0.2em] text-sky-400">Generated Code</span>
                    <div id="output-actions" class="flex gap-2">
                        <button onclick="downloadMcFunction()"
                            class="bg-emerald-600 hover:bg-emerald-500 text-[9px] font-black px-4 py-1.5 rounded uppercase tracking-widest flex items-center justify-center gap-1">
                            Download
                        </button>
                        <button onclick="copyToClipboard()" id="copyBtn"
                            class="bg-sky-600 hover:bg-sky-500 text-[9px] font-black px-4 py-1.5 rounded uppercase tracking-widest">Copy</button>
                        <button onclick="togglePanel(false)"
                            class="text-slate-500 hover:text-white p-1 ml-auto sm:ml-0">
                            <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd"
                                    d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z"
                                    clip-rule="evenodd"></path>
                            </svg>
                        </button>
                    </div>
                </div>
                <div id="commandOutput"
                    class="bg-black/30 p-4 rounded font-mono text-[10px] leading-relaxed text-emerald-400 overflow-y-auto custom-scrollbar border border-white/5 whitespace-pre-wrap flex-1">
                </div>
            </div>
        </main>

        <!-- Controls Sidebar (Bottom on Mobile, Left on Desktop) -->
        <!-- Order-2 on mobile ensures it's at the bottom. Order-1 on desktop puts it to the left. -->
        <aside id="sidebar-container"
            class="order-2 lg:order-1 w-full lg:w-80 h-[55vh] lg:h-full panel-bg border-t lg:border-t-0 lg:border-r border-white/5 flex flex-col z-20 shadow-[0_-10px_40px_rgba(0,0,0,0.5)] lg:shadow-none">

            <!-- "Outliner" Style Header -->
            <div
                class="h-9 flex-none bg-[#111827] border-b border-white/5 flex items-center px-4 justify-between select-none">
                <div class="flex items-center gap-2 text-slate-400">
                    <svg class="w-3.5 h-3.5" fill="currentColor" viewBox="0 0 20 20">
                        <path
                            d="M7 3a1 1 0 000 2h6a1 1 0 100-2H7zM4 7a1 1 0 011-1h10a1 1 0 110 2H5a1 1 0 01-1-1zM2 11a2 2 0 012-2h12a2 2 0 012 2v4a2 2 0 01-2 2H4a2 2 0 01-2-2v-4z">
                        </path>
                    </svg>
                    <span class="text-[10px] font-bold uppercase tracking-wider">Settings & Properties</span>
                </div>
                <span class="text-[9px] text-slate-600 font-mono">1/1</span>
            </div>

            <!-- Scrollable Controls Area -->
            <div class="flex-1 overflow-y-auto custom-scrollbar p-5 space-y-6">
                <!-- Target Configuration -->
                <section>
                    <label class="block text-[10px] font-extrabold text-sky-500 uppercase tracking-wider mb-2">Target
                        ID</label>
                    <div class="space-y-3">
                        <div>
                            <input type="text" id="entityTag" value="wiki:fmbe"
                                class="w-full input-box rounded px-3 py-2 text-xs font-mono focus:ring-1 ring-sky-500 outline-none placeholder-slate-600"
                                placeholder="e.g., wiki:my_entity">
                        </div>
                    </div>
                </section>

                <!-- Item Configuration -->
                <section>
                    <label class="block text-[10px] font-extrabold text-pink-500 uppercase tracking-wider mb-2">Held
                        Item</label>
                    <div class="space-y-3">
                        <select id="itemID"
                            class="w-full input-box rounded px-3 py-2 text-xs focus:ring-1 ring-pink-500 outline-none cursor-pointer">
                            <optgroup label="Common Blocks">
                                <option value="stone">Stone</option>
                                <option value="grass_block">Grass Block</option>
                                <option value="dirt">Dirt</option>
                                <option value="cobblestone">Cobblestone</option>
                                <option value="planks">Oak Planks</option>
                                <option value="bedrock">Bedrock</option>
                                <option value="sand">Sand</option>
                                <option value="gravel">Gravel</option>
                                <option value="gold_block">Gold Block</option>
                                <option value="iron_block">Iron Block</option>
                                <option value="diamond_block">Diamond Block</option>
                            </optgroup>
                            <optgroup label="Nature & Environment">
                                <option value="log">Oak Log</option>
                                <option value="leaves">Oak Leaves</option>
                                <option value="glass">Glass</option>
                                <option value="obsidian">Obsidian</option>
                                <option value="chest">Chest</option>
                                <option value="crafting_table">Crafting Table</option>
                                <option value="furnace">Furnace</option>
                                <option value="tnt">TNT</option>
                                <option value="bookshelf">Bookshelf</option>
                                <option value="emerald_block">Emerald Block</option>
                                <option value="beacon">Beacon</option>
                            </optgroup>
                            <optgroup label="Nether & End">
                                <option value="netherrack">Netherrack</option>
                                <option value="soul_sand">Soul Sand</option>
                                <option value="glowstone">Glowstone</option>
                                <option value="end_stone">End Stone</option>
                                <option value="purpur_block">Purpur Block</option>
                            </optgroup>
                        </select>
                    </div>
                </section>

                <!-- Texture Upload -->
                <section>
                    <label
                        class="block text-[10px] font-extrabold text-purple-400 uppercase tracking-wider mb-2">Texture</label>
                    <input type="file" id="textureInput" class="hidden" accept="image/*"
                        onchange="handleTextureUpload(this)">
                    <button onclick="document.getElementById('textureInput').click()"
                        class="w-full border border-dashed border-slate-700 py-2.5 rounded text-[10px] font-bold text-slate-400 hover:border-sky-500 hover:text-sky-400 transition-all uppercase flex items-center justify-center gap-2">
                        <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path
                                d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z" />
                        </svg>
                        Upload Texture
                    </button>
                </section>

                <!-- Transforms Group -->
                <div class="bg-black/20 p-3 rounded-lg border border-white/5 space-y-6">
                    <section>
                        <div class="flex justify-between items-center mb-3">
                            <h3
                                class="text-[10px] font-extrabold text-sky-400 uppercase tracking-wider flex items-center gap-2">
                                <span class="w-1.5 h-1.5 rounded-full bg-sky-400"></span> Position
                            </h3>
                            <button onclick="resetValues('trans')"
                                class="text-[9px] font-bold text-slate-500 hover:text-white transition-colors">RESET</button>
                        </div>
                        <div class="space-y-4">
                            <div class="flex items-center gap-3">
                                <span class="text-[10px] font-bold w-4 text-slate-400">X</span>
                                <input type="range" id="tx" min="-16" max="16" step="0.01" value="0" class="flex-1">
                                <span id="val-tx" class="text-[10px] font-mono text-sky-300 w-10 text-right">0.00</span>
                            </div>
                            <div class="flex items-center gap-3">
                                <span class="text-[10px] font-bold w-4 text-slate-400">Y</span>
                                <input type="range" id="ty" min="-16" max="16" step="0.01" value="0" class="flex-1">
                                <span id="val-ty" class="text-[10px] font-mono text-sky-300 w-10 text-right">0.00</span>
                            </div>
                            <div class="flex items-center gap-3">
                                <span class="text-[10px] font-bold w-4 text-slate-400">Z</span>
                                <input type="range" id="tz" min="-16" max="16" step="0.01" value="0" class="flex-1">
                                <span id="val-tz" class="text-[10px] font-mono text-sky-300 w-10 text-right">0.00</span>
                            </div>
                        </div>
                    </section>

                    <section>
                        <div class="flex justify-between items-center mb-3">
                            <h3
                                class="text-[10px] font-extrabold text-emerald-400 uppercase tracking-wider flex items-center gap-2">
                                <span class="w-1.5 h-1.5 rounded-full bg-emerald-400"></span> Scale
                            </h3>
                            <button onclick="resetValues('scale')"
                                class="text-[9px] font-bold text-slate-500 hover:text-white transition-colors">RESET</button>
                        </div>
                        <div class="flex items-center gap-3">
                            <span class="text-[10px] font-bold w-4 text-slate-400">S</span>
                            <input type="range" id="s" min="0.1" max="10" step="0.01" value="1" class="flex-1">
                            <span id="val-s" class="text-[10px] font-mono text-emerald-300 w-10 text-right">1.00</span>
                        </div>
                    </section>

                    <section>
                        <div class="flex justify-between items-center mb-3">
                            <h3
                                class="text-[10px] font-extrabold text-amber-500 uppercase tracking-wider flex items-center gap-2">
                                <span class="w-1.5 h-1.5 rounded-full bg-amber-500"></span> Rotation
                            </h3>
                            <button onclick="resetValues('rot')"
                                class="text-[9px] font-bold text-slate-500 hover:text-white transition-colors">RESET</button>
                        </div>
                        <div class="space-y-4">
                            <div class="flex items-center gap-3">
                                <span class="text-[10px] font-bold w-4 text-slate-400">X</span>
                                <input type="range" id="rx" min="-180" max="180" value="0" class="flex-1">
                                <span id="val-rx" class="text-[10px] font-mono text-amber-300 w-10 text-right">0°</span>
                            </div>
                            <div class="flex items-center gap-3">
                                <span class="text-[10px] font-bold w-4 text-slate-400">Y</span>
                                <input type="range" id="ry" min="-180" max="180" value="0" class="flex-1">
                                <span id="val-ry" class="text-[10px] font-mono text-amber-300 w-10 text-right">0°</span>
                            </div>
                            <div class="flex items-center gap-3">
                                <span class="text-[10px] font-bold w-4 text-slate-400">Z</span>
                                <input type="range" id="rz" min="-180" max="180" value="0" class="flex-1">
                                <span id="val-rz" class="text-[10px] font-mono text-amber-300 w-10 text-right">0°</span>
                            </div>
                        </div>
                    </section>
                </div>

                <div class="pb-10">
                    <button id="generateBtn" onclick="handleGenerate()"
                        class="w-full bg-sky-500 hover:bg-sky-400 py-3 rounded text-[11px] font-black uppercase tracking-widest shadow-lg shadow-sky-500/20 active:scale-95 transition-all text-white">
                        Generate Function
                    </button>
                </div>
            </div>
        </aside>

    </div>

    <script>
        let scene, camera, renderer, model;
        const container = document.getElementById('viewport-container');

        function init3D() {
            scene = new THREE.Scene();
            scene.background = new THREE.Color(0x0b111d);

            // Initial camera setup
            const aspect = container.clientWidth / container.clientHeight;
            camera = new THREE.PerspectiveCamera(50, aspect, 0.1, 1000);
            camera.position.set(5, 5, 5);
            camera.lookAt(0, 0, 0);

            renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
            renderer.setSize(container.clientWidth, container.clientHeight);
            renderer.setPixelRatio(window.devicePixelRatio);
            container.appendChild(renderer.domElement);

            // Lighting
            scene.add(new THREE.AmbientLight(0xffffff, 0.7));
            const dl = new THREE.DirectionalLight(0xffffff, 0.6);
            dl.position.set(10, 20, 10);
            scene.add(dl);
            const dl2 = new THREE.DirectionalLight(0x38bdf8, 0.3); // Sky blue rim light
            dl2.position.set(-5, 0, -5);
            scene.add(dl2);

            // Grid
            const grid = new THREE.GridHelper(20, 20, 0x1e293b, 0x161e2b);
            scene.add(grid);

            // Default Cube
            const geo = new THREE.BoxGeometry(1, 1, 1);
            const mat = new THREE.MeshStandardMaterial({
                color: 0x38bdf8,
                roughness: 0.3,
                metalness: 0.1,
                transparent: true,
                opacity: 0.9
            });
            model = new THREE.Mesh(geo, mat);

            // Edges for "Selected" look
            const edges = new THREE.EdgesGeometry(geo);
            const line = new THREE.LineSegments(edges, new THREE.LineBasicMaterial({ color: 0xffffff, transparent: true, opacity: 0.3 }));
            model.add(line);

            scene.add(model);

            const axes = new THREE.AxesHelper(2);
            scene.add(axes);

            function animate() {
                requestAnimationFrame(animate);
                renderer.render(scene, camera);
            }
            animate();
        }

        function handleTextureUpload(input) {
            if (input.files && input.files[0]) {
                const reader = new FileReader();
                reader.onload = function (e) {
                    const textureLoader = new THREE.TextureLoader();
                    textureLoader.load(e.target.result, (texture) => {
                        texture.magFilter = THREE.NearestFilter;
                        texture.minFilter = THREE.NearestFilter;
                        texture.colorSpace = THREE.SRGBColorSpace;
                        if (model) {
                            model.material.map = texture;
                            model.material.color.set(0xffffff);
                            model.material.needsUpdate = true;
                        }
                    });
                };
                reader.readAsDataURL(input.files[0]);
            }
        }

        function updateValues() {
            const tx = parseFloat(document.getElementById('tx').value);
            const ty = parseFloat(document.getElementById('ty').value);
            const tz = parseFloat(document.getElementById('tz').value);
            const s = parseFloat(document.getElementById('s').value);
            const rx = parseFloat(document.getElementById('rx').value);
            const ry = parseFloat(document.getElementById('ry').value);
            const rz = parseFloat(document.getElementById('rz').value);

            document.getElementById('val-tx').innerText = tx.toFixed(2);
            document.getElementById('val-ty').innerText = ty.toFixed(2);
            document.getElementById('val-tz').innerText = tz.toFixed(2);
            document.getElementById('val-s').innerText = s.toFixed(2);
            document.getElementById('val-rx').innerText = rx + '°';
            document.getElementById('val-ry').innerText = ry + '°';
            document.getElementById('val-rz').innerText = rz + '°';

            if (model) {
                model.position.set(tx, ty, tz);
                model.scale.set(s, s, s);
                model.rotation.set(THREE.MathUtils.degToRad(rx), THREE.MathUtils.degToRad(ry), THREE.MathUtils.degToRad(rz));
            }
        }

        function togglePanel(show) {
            const panel = document.getElementById('outputPanel');
            if (show) {
                panel.classList.remove('translate-y-[120%]', 'opacity-0', 'pointer-events-none');
            } else {
                panel.classList.add('translate-y-[120%]', 'opacity-0', 'pointer-events-none');
            }
        }

        function handleGenerate() {
            const targetName = 'wiki:fmbe'; // Fixed on fox entity
            const targetTag = document.getElementById('entityTag').value || 'wiki:fmbe';
            const itemID = document.getElementById('itemID').value || 'stone';

            const tx = parseFloat(document.getElementById('tx').value).toFixed(4);
            const ty = parseFloat(document.getElementById('ty').value).toFixed(4);
            const tz = parseFloat(document.getElementById('tz').value).toFixed(4);
            const s = parseFloat(document.getElementById('s').value).toFixed(4);
            const rx = document.getElementById('rx').value;
            const ry = document.getElementById('ry').value;
            const rz = document.getElementById('rz').value;

            const adscale = Math.sqrt(s).toFixed(4);
            const adscaled = (2.1385 * adscale).toFixed(4);

            const setupCmd = `## Setup Configuration\ntag @e[name="${targetName}"] add ${targetTag}\nreplaceitem entity @e[name="${targetName}",c=1] slot.weapon.mainhand 0 ${itemID}`;

            const scaleCmd = `## Scale Animation\nplayanimation @e[tag=${targetTag}] animation.player.sleeping none 0 "" controller.animation.fox.move\n\nplayanimation @e[tag=${targetTag}] animation.creeper.swelling none 0 "v.scale=${s};v.adscale=math.sqrt(v.scale);v.adscaled=${adscaled};v.xbasepos=0;v.ybasepos=0;v.zbasepos=0;v.xpos=${tx};v.ypos=${ty};v.zpos=${tz};v.xrot=q.life_time*0;v.yrot=q.life_time*0;v.zrot=q.life_time*20;v.swelling_scale1=v.adscaled;v.swelling_scale2=v.adscaled;" wiki:scale`;

            const posRotCmd = `## Position & Rotation Animation\nplayanimation @e[tag=${targetTag}] animation.ender_dragon.neck_head_movement none 0 "v.adjust_xz=8*v.adscaled+v.zbasepos/v.adscaled;v.adjust_y=(-5-v.ybasepos/v.adscaled/v.adscaled)*v.adscaled;v.x=v.xbasepos/v.adscaled;v.y=v.adjust_y;v.z=v.adjust_xz;v.ty=v.y*math.cos(v.xrot)-v.z*math.sin(v.xrot);v.tz=v.y*math.sin(v.xrot)+v.z*math.cos(v.xrot);v.y=v.ty;v.z=v.tz;v.tx=-v.x*math.cos(v.zrot)+v.y*math.sin(v.zrot);v.ty=v.x*math.sin(v.zrot)+v.y*math.cos(v.zrot);v.x=v.tx;v.y=v.ty;v.tx=v.x*math.cos(v.yrot)+v.z*math.sin(v.yrot);v.tz=-v.x*math.sin(v.yrot)+v.z*math.cos(v.yrot);v.x=v.tx;v.z=v.tz;v.head_position_x=v.x+v.xpos/v.adscaled;v.head_position_y=7.48/v.adscale+v.z+v.zpos/v.adscaled;v.head_position_z=v.y-v.ypos/v.adscaled;v.head_rotation_x=90+${rx};v.head_rotation_y=${rz};v.head_rotation_z=${ry};" wiki:posrot`;

            const setVarCmd = `## Variable State Editor\nplayanimation @e[tag=${targetTag}] animation.player.attack.positions none 0 "v.xrot=${rx};v.yrot=${ry};v.zrot=${rz};v.ypos=${ty};v.xpos=${tx};v.zpos=${tz};v.scale=${s};" wiki:setvariable`;

            const output = `${setupCmd}\n\n${scaleCmd}\n\n${posRotCmd}\n\n${setVarCmd}`;

            document.getElementById('commandOutput').innerText = output;
            togglePanel(true);
        }

        function downloadMcFunction() {
            const text = document.getElementById('commandOutput').innerText;
            const lines = text.split('\n').filter(l => l.trim() && !l.startsWith('##'));
            const blob = new Blob([lines.join('\n')], { type: 'text/plain' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            const tag = document.getElementById('entityTag').value || 'display_entity';
            a.href = url;
            a.download = `${tag.replace(':', '_')}.mcfunction`;
            a.click();
            window.URL.revokeObjectURL(url);
        }

        function copyToClipboard() {
            const text = document.getElementById('commandOutput').innerText;
            const el = document.createElement('textarea');
            el.value = text;
            document.body.appendChild(el);
            el.select();
            document.execCommand('copy');
            document.body.removeChild(el);
            const btn = document.getElementById('copyBtn');
            const originalText = btn.innerText;
            btn.innerText = "COPIED!";
            setTimeout(() => btn.innerText = originalText, 2000);
        }

        function resetValues(group) {
            if (group === 'trans') ['tx', 'ty', 'tz'].forEach(id => document.getElementById(id).value = 0);
            if (group === 'scale') ['s'].forEach(id => document.getElementById(id).value = 1);
            if (group === 'rot') ['rx', 'ry', 'rz'].forEach(id => document.getElementById(id).value = 0);
            updateValues();
        }

        function resetAll() {
            resetValues('trans'); resetValues('scale'); resetValues('rot');
            document.getElementById('itemID').value = 'stone';
            document.getElementById('entityTag').value = 'wiki:fmbe';
            if (model) {
                model.material.map = null;
                model.material.color.set(0x38bdf8);
                model.material.needsUpdate = true;
            }
            togglePanel(false);
        }

        document.querySelectorAll('input, select').forEach(i => i.addEventListener('input', updateValues));

        window.onload = () => { init3D(); updateValues(); };

        // Robust resize handler for split screen
        window.addEventListener('resize', () => {
            if (camera && renderer && container) {
                camera.aspect = container.clientWidth / container.clientHeight;
                camera.updateProjectionMatrix();
                renderer.setSize(container.clientWidth, container.clientHeight);
            }
        });
    </script>
</body>

</html>